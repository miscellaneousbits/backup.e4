echo "*** Decompress $1 image ***"
gunzip -k data/$1.img.gz
echo "*** backup $1 image ***"
./backup.e4 data/$1.img > test.bak
echo "*** zero the test image ***"
dd if=/dev/zero of=restored.img count=`stat --printf="%s" data/$1.img` iflag=count_bytes
echo "*** restore test image ***"
cat test.bak | ./restore.e4 restored.img
echo "*** check test image file system file system ***"
e2fsck -f -y restored.img
echo "*** loopback setup ***"
LOOP1=$(losetup -f)
sudo losetup $LOOP1 data/$1.img
LOOP2=$(losetup -f)
sudo losetup $LOOP2 restored.img
[ ! -d "fs1" ] && mkdir fs1
[ ! -d "fs2" ] && mkdir fs2
sudo mount $LOOP1 fs1
sudo mount $LOOP2 fs2
echo "*** compare files ***"
sudo diff -qr fs1/ fs2/
sudo umount fs1
sudo umount fs2
sudo losetup -d $LOOP1
sudo losetup -d $LOOP2
rm restored.img data/$1.img test.bak
